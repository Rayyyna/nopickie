# NoPickie 统计功能 PRD（简化版）

## 一、功能概述

在主窗口新增统计面板，展示用户的手贱行为数据，帮助用户追踪习惯改善情况。

**核心目标：**
- 让用户了解每天的触发次数
- 提供直观的7天历史数据可视化
- 支持周级别历史数据查看

---

## 二、核心指标定义

### 2.1 数据维度

**每日记录维度：**
- `date`：日期（格式：YYYY-MM-DD）
- `trigger_count`：触发次数（当天触发的总次数）

**说明：**
- 移除使用时长和触发频率，只关注触发次数
- 更直观、更简单

### 2.2 数据记录规则

**实时更新：**
- 今天的触发次数实时更新，显示在"今天统计"卡片中
- 今天的数据**不出现**在图表中

**历史数据：**
- 每天零点，前一天的数据自动进入历史
- 图表只显示**昨天及之前的7天**数据
- 新的一天从0次开始

---

## 三、数据存储

### 3.1 存储位置

- 文件路径：`~/.nopickie/stats.json`
- 格式：JSON

### 3.2 数据结构

```json
{
  "2025-10-23": {
    "trigger_count": 15
  },
  "2025-10-22": {
    "trigger_count": 8
  },
  "2025-10-21": {
    "trigger_count": 12
  }
}
```

### 3.3 存储规则

- 按天记录，key 为日期字符串
- 每次触发时 trigger_count +1，立即保存
- 跨0点自动切换到新一天，前一天数据进入历史

---

## 四、UI 设计

### 4.1 整体布局

```
┌─────────────────────────────────────┐
│  NoPickie                      [×]  │
├─────────────────────────────────────┤
│  [启动检测]  [停止检测]  [打开调试]  │
├─────────────────────────────────────┤
│  状态：检测中                        │
│  今日触发：5次                       │
├─────────────────────────────────────┤
│  📊 使用统计                         │
├─────────────────────────────────────┤
│  今天                                │
│  ┌────────────┐  ┌────────────┐     │
│  │ 2.1次/小时  │  │ 使用 2.5h  │     │
│  │ 🟢 优秀     │  │ 触发 5次   │     │
│  └────────────┘  └────────────┘     │
├─────────────────────────────────────┤
│  📈 本周触发频率         [◀ 本周 ▶] │
│     ┌──────────────────────────┐    │
│  10 │  ●                       │    │
│   5 │    ●  ●  ●  ●  ●  ●  ●   │    │
│   0 └──────────────────────────┘    │
│      17  18  19  20  21  22  23    │
│      一  二  三  四  五  六  日      │
└─────────────────────────────────────┘
```

### 4.2 今天数据卡片

**居中大卡片：今天触发次数**
- 主数据：`X 次`（字号：48px，加粗）
- 副标题：`今天触发次数`（字号：14px）
- 背景：渐变色卡片
- 实时更新：每次触发立即 +1

**样式：**
- 卡片背景：白色/浅灰
- 圆角：8px
- 内边距：16px
- 卡片间距：12px

### 4.3 周视图折线图

**图表配置：**
- 类型：折线图（Line Chart）
- 横轴：日期 + 星期（如：17 一、18 二）
- 纵轴：触发次数（次）
- 数据点：圆点标记（半径：4px）
- 线条：2px 实线，黄色主题色
- 网格线：浅灰色虚线

**重要规则：**
- 图表**只显示昨天及之前的7天**
- 今天的数据不出现在图表中
- 例如今天是10月23日，图表显示10月16日~10月22日

**图表尺寸：**
- 宽度：380px
- 高度：200px

### 4.4 周切换控制

**位置：**
- 图表标题右侧

**样式：**
- 格式：`[◀ 本周 ▶]`
- 左箭头：上一周
- 中间文字：当前周标签
- 右箭头：下一周

**状态：**
- 可点击：默认样式，蓝色
- 禁用：灰色，不可点击
  - ▶ 在"本周"时禁用
  - ◀ 在"12周前"时禁用

---

## 五、功能逻辑

### 5.1 数据记录流程

```
用户点击"启动检测"
  ↓
开始检测（无需记录时间）
  ↓
检测到触发
  ↓
today.trigger_count += 1
立即保存到 JSON
立即刷新"今天统计"卡片
  ↓
用户点击"停止检测"
  ↓
停止检测（无需记录时长）
```

### 5.2 周视图数据加载

**重要规则：图表显示昨天及之前的7天**

**周定义：**
- 周一为一周开始（第1天）
- 周日为一周结束（第7天）
- **今天的数据不显示在图表中**

**周偏移量（week_offset）：**
- 0：本周（但只显示本周中昨天及之前的天数）
- -1：上周
- -2：2周前
- -3：3周前
- ...
- -11：12周前（最多回溯）

**数据查询逻辑：**
1. 根据 week_offset 计算周的开始日期和结束日期
2. 从 stats.json 中读取这7天的数据
3. **如果是今天的数据，跳过不显示**
4. 如果某天没有数据，返回 null

**示例（今天是2025-10-23，周三）：**
- week_offset = 0（本周）：
  - 周范围：10月20日（周一）~ 10月26日（周日）
  - 图表只显示：10月20日、21日、22日（昨天及之前）
  - 今天（23日）及未来（24、25、26日）不显示

**周标签显示：**
- week_offset = 0 → "本周"
- week_offset = -1 → "上周"
- week_offset = -2 → "2周前"
- week_offset = -3 → "3周前"

### 5.3 周切换交互

**点击 ◀（上一周）：**
```
if week_offset > -11:
    week_offset -= 1
    加载新周数据
    刷新图表
    if week_offset == -11:
        禁用 ◀ 按钮
    启用 ▶ 按钮
```

**点击 ▶（下一周）：**
```
if week_offset < 0:
    week_offset += 1
    加载新周数据
    刷新图表
    if week_offset == 0:
        禁用 ▶ 按钮
    启用 ◀ 按钮
```

### 5.4 实时更新

**触发场景：**
- 启动检测时：加载今天数据 + 本周历史数据（昨天及之前）
- 每次触发时：更新今天卡片（触发次数 +1）
- 跨0点时：前一天数据自动进入历史，今天重置为0，刷新图表

**更新策略：**
- 今天数据：实时更新，显示在卡片中
- 周视图数据：只显示昨天及之前，不包括今天

---

## 六、边界条件处理

### 6.1 首次使用

**现象：**
- 没有历史数据

**处理：**
- 今天卡片显示：`0 次`
- 周视图显示：空图表（因为没有昨天及之前的数据）

### 6.2 数据不足7天

**现象：**
- 用户使用不足7天

**处理：**
- 只显示已有天数的数据点（昨天及之前的）
- 没有数据的天数不显示数据点

### 6.3 今天未触发

**现象：**
- 今天触发次数 = 0

**处理：**
- 显示：`0 次`
- 图表不包括今天，所以不影响图表

### 6.4 跨天处理

**逻辑：**
- 每次触发时检查当前日期
- 如果日期变化（跨0点）：
  - 前一天数据自动进入历史（可在图表中看到）
  - 今天数据从0开始
  - 自动刷新图表

### 6.5 数据文件丢失

**现象：**
- stats.json 被删除或损坏

**处理：**
- 自动创建新文件
- 从0开始记录

---

## 七、技术实现要点

### 7.1 前端（HTML/JS + Tauri）

**UI 框架：**
- 原生 HTML/CSS/JS
- Chart.js（绘制折线图）

**关键函数：**
- `loadTodayStats()`：加载今天数据
- `loadWeekStats(week_offset)`：加载周数据
- `renderChart(data)`：渲染折线图
- `updateTodayCard(stats)`：更新今天卡片
- `switchWeek(direction)`：切换周

### 7.2 后端（Rust）

**新增模块：**
- `src-tauri/src/stats.rs`：统计逻辑（简化版）

**Tauri Commands：**
```rust
#[tauri::command]
fn get_today_stats() -> Result<TodayStatsResponse, String>

#[tauri::command]
fn get_week_stats(week_offset: i32) -> Result<WeekStatsResponse, String>

#[tauri::command]
fn record_trigger() -> Result<(), String>
```

**数据结构：**
```rust
#[derive(Serialize, Deserialize)]
struct DailyStats {
    date: String,
    trigger_count: u32,  // 只需要这个
}

#[derive(Serialize)]
struct TodayStatsResponse {
    date: String,
    trigger_count: u32,
}

#[derive(Serialize)]
struct WeekStatsResponse {
    week_label: String,        // "本周" / "上周" / "2周前"
    week_start: String,        // "2025-10-20"
    week_end: String,          // "2025-10-26"
    days: Vec<Option<DailyStats>>, // 昨天及之前的数据，今天不包括
    can_go_next: bool,
    can_go_prev: bool,
}
```

### 7.3 存储策略

**立即保存：**
- 每次触发立即保存到 JSON
- 无需定时任务

**跨天检查：**
- 每次触发时检查当前日期
- 日期变化时自动切换到新一天

---

## 八、窗口尺寸调整

**当前尺寸：**
- 宽度：800px
- 高度：700px

**调整为：**
- 宽度：850px
- 高度：1000px

**原因：**
- 容纳统计面板（简化后的卡片 + 图表 + 周切换）

---

## 九、不实现的功能

以下功能**不实现**：
1. ❌ 使用时长追踪
2. ❌ 触发频率（次/小时）计算
3. ❌ 评级系统（优秀/良好等）
4. ❌ 详情页（点击日期查看详情）
5. ❌ 日历热力图
6. ❌ 数据导出（CSV/JSON）
7. ❌ 数据清除功能
8. ❌ 成就系统
9. ❌ 数据同步/备份
10. ❌ 趋势对比文案

---

## 十、验收标准

### 10.1 功能验收

- [ ] 启动检测后，今天数据卡片显示 0 次
- [ ] 每次触发，今天触发次数立即 +1
- [ ] 今天的数据不出现在图表中
- [ ] 图表只显示昨天及之前的7天数据
- [ ] 点击 ◀ 可查看上一周，点击 ▶ 可查看下一周
- [ ] 在"本周"时，▶ 禁用
- [ ] 在"12周前"时，◀ 禁用
- [ ] 跨0点后，前一天数据自动进入图表，今天重置为0
- [ ] 数据持久化，重启应用后数据不丢失

### 10.2 UI 验收

- [ ] 今天触发次数卡片居中显示，字体大
- [ ] 折线图数据点清晰可见
- [ ] 横轴标签正确（日期 + 星期）
- [ ] 图表不包括今天的数据点
- [ ] 卡片样式美观，间距合理
- [ ] 周切换按钮交互流畅

### 10.3 边界情况验收

- [ ] 首次使用，今天显示 0 次，图表为空
- [ ] 不足7天只显示已有历史数据（昨天及之前）
- [ ] 数据文件丢失后自动创建新文件
- [ ] 本周查看时，今天及未来的天数不显示在图表中

---

## 十一、开发排期（简化版）

**总工时：**
- 后端简化：2小时
- 前端简化：2小时
- 联调测试：1小时
- **合计：5小时**

**里程碑：**
1. 后端 stats.rs 模块简化（只记录触发次数）
2. 前端 UI 简化（移除使用时长、频率、评级）
3. 图表逻辑调整（只显示昨天及之前）
4. 测试跨天逻辑
5. 联调测试通过

---

## 十二、未来迭代方向（不在本次实现）

- 使用时长追踪（如果用户需要）
- 触发频率分析
- 成就系统
- 数据导出
- 月度报告

---

**文档版本：** v2.0（简化版）  
**最后更新：** 2025-10-23

